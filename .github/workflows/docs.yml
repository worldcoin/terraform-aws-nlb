name: Terraform
on:
  push:
    branches:
      - main

jobs:
  docs:
    name: docs
    runs-on: [self-hosted, amd64]

    permissions:
      pull-requests: write
      contents: write

    steps:
      - uses: actions/checkout@v4
        name: Checkout source code

      - name: Render terraform docs inside the README.md and push changes back to main branch
        uses: terraform-docs/gh-actions@v1.2.0

      # fix to terraform-docs action change ownership of files
      - name: Update ownership of files
        run: |
          sudo chown $(id -u):$(id -g) -R .git/

      - name: Check for available updates
        id: check-existence
        run: |
          echo "::set-output name=branches::$(git ls-remote --heads origin generated-docs-\* | tr -d '\n')"

      - name: Create Pull Request
        if: steps.check-existence.outputs.branches == ''
        uses: peter-evans/create-pull-request@v7
        with:
          title: Update terraform docs
          branch: generated-docs
          branch-suffix: short-commit-hash
          delete-branch: true
          commit-message: "docs: autogenerated docs"
          add-paths: |
            **/README.md
